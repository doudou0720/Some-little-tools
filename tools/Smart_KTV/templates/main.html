<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>歌词同步</title>
    <style>
        body {
            background:url("{{ url_for('static',filename='images/'+name+'.jpg')}}") center no-repeat ;
            background-size:60% 100%;
        }
        * {
            margin:0 auto;
            padding:0;
        }
        .play {
            color: #01e5ff;
            font-size: 24px;
        }
 
        .overPlay {
            font-size: inherit;
            color: #fff;
        }
 
        #div_lrc {
            position: absolute;
            padding-top: 0px;
            left: 28%;
            top: 300px;
            width:50%;
            transition: top .5s;
            margin: 0 auto;
            
        }
 
        .div_DisLrc {
            overflow: hidden;
            color:#b1abab;
            width: 70%;
            height: 600px;  
            position: relative;
            margin: 0 auto;
            
        }
 
        #audio {
            width: 100%;
        }
 
        .div_audio {
            width: 50%;
            margin: 0 auto;
        }
 
        .div_but {
            position: absolute;
            font-size: 26px;
            font-weight: 900;
            top: 40%;
            right: 0%;
        }
 
            .div_but p {
                cursor: pointer;
            }
    </style>
</head>
 
 
 
<body>
    <div id="div_1" style="display: none;">
    </div>
    <!-- 歌词显示界面 -->
    <div class="div_DisLrc">
        <div id="div_lrc">
            <p id="lrc_row1"></p>
        </div>
        <!-- 用于调整歌词位置 -->
        <div class="div_but">
            <p οnmοusedοwn="time = setInterval(btn_down,0)" οnmοuseup="clearInterval
(time)"><i class="iconfont icon-top"></i></p>
            <p οnmοusedοwn="time = setInterval(btn_top,0)" οnmοuseup="clearInterval
(time)"><i class="iconfont icon-down"></i></p>
        </div>
    </div>
    <!-- 播放器控件 -->
    <div class="div_audio">
        <audio id="audio" controls="controls" autoplay="autoplay">
            <source src="{{ url_for('static',filename='audios/'+name+'.mp3') }}" type="audio/mpeg">
        </audio>
    </div>
 
 
 
    <script src="{{ url_for('static',filename='js/jquery-3.6.1.js') }}"></script>
    <script>
        var audio = document.getElementById("audio");
        var play = $("#lrc_row1");
        var ms = 0;
        //将歌词添加到div中
        $(document).ready(function () {
            //加载歌词
            $('#div_1').load("{{ url_for('static',filename='audios/'+name+'.lrc') }}");
            //获取所有歌词
            setTimeout(function () {
                var lrcArr = $("#div_1").text().split('\n');
                for (var i = 4; i < lrcArr.length; i++) {
                    var p = document.createElement("p");
                    //空白歌词不进行加载
                    if (lrcArr[i].substring(11) != "") {
                        p.innerText = lrcArr[i].substring(11);
                        $("#div_lrc").append(p);
                    }
                }
            }, 200)
        })
 
        function lrcDisplay() {
            //获取播放进度(转换的格式为: 00:00)
            var minute = parseInt(audio.currentTime / 60);//分钟
            minute = minute == 0 ? "00" : (minute + "").length < 2 ? "0" + minute : minute;
            //获取秒数
            var second = (parseInt(audio.currentTime)) % 60;
            second = second == 0 ? "00" : (second + "").length < 2 ? "0" + second : second;
            //正则表达匹配歌词
            //console.log(minute,second)
            var regex = new RegExp('\\[' + (minute + ":" + second) + '.+\\].+\n');
            var text = regex.exec($("#div_1").text());
            if (text != null) {
                //console.log(ms)
                var str1 = new String($(play).next().text());
                var str2 = new String(text[0].substring(11));
                if (ms > 100 * minute + second){
                    play = $("#lrc_row1");
                }
                if (str1.trim() == str2.trim()) {
                    //歌词颜色变色
                    $(play).attr("class", "overPlay");
                    play = $(play).next();
                    $(play).attr("class", "play");
                    //歌词滚动(自动)
                    var top = parseInt($("#div_lrc").css("top"));
                    $("#div_lrc").css("top", -1 * ((-1 * top) + 22) + "px");
                    ms = 100 * minute + second
                }
            }
        }
        setInterval(lrcDisplay, 500);
        //歌词滚动(手动)
        var time = null;
        function btn_top() {
            var top = parseInt($("#div_lrc").css("top"));
            $("#div_lrc").css("top", -1 * ((-1 * top) + 100) + "px");
        }
        function btn_down() {
            var top = parseInt($("#div_lrc").css("top"));
            if (top <= 0)
                $("#div_lrc").css("top", -1 * ((-1 * top) - 100) + "px");
        }
 
        //调整歌词位置的函数
        function btn_top() {
            var top = parseInt($("#div_lrc").css("top"));
            $("#div_lrc").css("top", -1 * ((-1 * top) + 30) + "px");
        }
        /*
            1.歌词文件不能是默认编码(记事本文件和lrc文件默认为ANSI编码) 只需要改为 UTF-8或
者GB2312,否则乱码
            2.歌曲因为没有算毫秒差距,可能出现细微误差
            3.因为网页同源策略的原因,外部直接打开html文件只能用firefox访问,
               不能进行跨域访问,如果不使用文件读取可以在任意地方打开.
            4.因为ajax识别原因,会把空格当做分割内容,即歌词文件名不能有空格
            5.因为js对文件操作以及ajax请求存在诸多默认限制,若以类似方法在winfrom asp等中很
多问题都会得到解决.
            6.setTimeout()和setInterval()，在浏览器窗口非激活的状态下会停止工作或者以极慢的
速度工作。目前我已知就IE不会有这种问题。
        */
    </script>
</body>
</html>